#!/bin/sh

#####################################################################################
##
## "main" procedure
##

MODLIST=`lsmod | cut -f1,0 -d" " | grep ath_hal`

if [ "${MODLIST}" = "ath_hal" ]; then
    echo "Modules are load, skip!"
    killVAP ALL
fi

. /etc/ath/apcfg

WAN_IF=${WAN_IF:=eth0}
AP_VAP_NUM=${AP_VAP_NUM:=8}
rm -rf /tmp/br*
rm -rf /tmp/bc*
rm -rf /tmp/ap*
rm -rf /tmp/sta*
rm -rf /tmp/top*

if [ "${AP_CONF_ACFG}" = "1" ]; then
	prepareACFG load
	exit 0
fi

##
## Determine the number of radios installed
##

NUMRADIO_AHB=${NUMRADIO_AHB:=0}
NUMRADIO_PCI=`grep -c 168c /proc/bus/pci/devices`
NUMRADIO=`expr ${NUMRADIO_PCI} + ${NUMRADIO_AHB}`

##
## Make sure the number is 1 or 2.  Any other is invalid
##

if [ $NUMRADIO -gt 2 -o $NUMRADIO -lt 1 ]; then
    echo "INVALID CONFIGURATION, RADIO NOT INSTALLED"
    exit 255
fi

#ARRIS ADD START - relocated from QCA apup command
if [ "${YOCTO}" = "" ]; then
echo "0 0 128 0 128" > /proc/Burst_Gap_control_status/control
echo "1 0 128 0 128" > /proc/Burst_Gap_control_status/control
else
    echo "0 0 128 0 128" > /proc/udma/gap_burst_control
    echo "1 0 128 0 128" > /proc/udma/gap_burst_control
fi
#ARRIS ADD END

iwpriv wifi0 set_led_custom $AP_CUSTOM_LED
iwpriv wifi1 set_led_custom $AP_CUSTOM_LED_2
/etc/rc.d/rc.wlan up

##
## Set Mac address from AP_BSSID
##
if [ "_${AP_BSSID}" != "_" ]; then
	iwpriv wifi${AP_RADIO_ID} setHwaddr ${AP_BSSID}
fi	

if [ "_${AP_BSSID_9}" != "_" ]; then
	iwpriv wifi${AP_RADIO_ID_9} setHwaddr ${AP_BSSID_9}
fi
WEP_INTERFACE=0
if [ "_${AP_STARTMODE}" != "_" ]; then
    NUM_VAP=0
    VAP_COUNT_RADIO_0=0
    VAP_COUNT_RADIO_1=0
    STA_VAP_COUNT_RADIO_0=0
    STA_VAP_COUNT_RADIO_1=0

    echo "initial sequence, only create VAPs"

    for i in $my_vaps;
    do
        ITER_SSID="AP_SSID$i"
        ITER_MODE="AP_MODE$i"
        ITER_SECMODE="AP_SECMODE$i"
        ITER_RFPARAM="AP_RFPARAM$i"
        ITER_RADIO_ID="AP_RADIO_ID$i"
        ITER_ROOTAP_MAC="ROOTAP_MAC$i"
        ITER_AP_ENABLE="AP_ENABLE$i"
        #ARRIS ADD -  ITER_VAP_BSSID
        ITER_VAP_BSSID="AP_BSSID$i"
        VAP_NAME="ath$NUM_VAP"

				echo "VAP_NAME = ($VAP_NAME)"
        eval ITER_SSID=\$$ITER_SSID
        eval ITER_MODE=\$$ITER_MODE
        eval ITER_SECMODE=\$$ITER_SECMODE
        eval ITER_RFPARAM=\$$ITER_RFPARAM
        eval ITER_RADIO_ID=\$$ITER_RADIO_ID
        eval ITER_ROOTAP_MAC=\$$ITER_ROOTAP_MAC
        eval ITER_AP_ENABLE=\$$ITER_AP_ENABLE
        #ARRIS ADD -  ITER_VAP_BSSID
        eval ITER_VAP_BSSID=\$$ITER_VAP_BSSID
				
#        if [ "${ITER_AP_ENABLE}" != "1" ]; then
#	    			NUM_VAP=$(($NUM_VAP+1))
#            continue;
#        fi
#        if [ "x${ITER_SSID}" != "x" ]; then
            ITER_SSID=AP$i
            VAP_COUNT_VAR="VAP_COUNT_RADIO_$ITER_RADIO_ID"
            eval ITER_VAP_COUNT=\$$VAP_COUNT_VAR
            ITER_VAP_COUNT=$(($ITER_VAP_COUNT+1))
            export $VAP_COUNT_VAR=$ITER_VAP_COUNT
            if [ "$VAP_COUNT_RADIO_0" -gt "$MAX_VAPS_PER_RADIO" -o "$VAP_COUNT_RADIO_1" -gt "$MAX_VAPS_PER_RADIO" ]; then
                echo "Exceeded max VAPs per Radio($MAX_VAPS_PER_RADIO)"
                exit 255
            fi
            if [ "$VAP_COUNT_RADIO_0" -gt "$AP_VAP_NUM" ]; then
                if [ "$ITER_RADIO_ID" == "0" ]; then
                		echo "Exceeded VAP num per Radio($AP_VAP_NUM) continue"
                		NUM_VAP=$(($NUM_VAP+1))
                		continue
                fi		
            fi
            if [ "$VAP_COUNT_RADIO_1" -gt "$AP_VAP_NUM" ]; then
                if [ "$ITER_RADIO_ID" == "1" ]; then
                		echo "Exceeded VAP num per Radio($AP_VAP_NUM) continue"
                		NUM_VAP=$(($NUM_VAP+1))
                		continue
                fi		
            fi
#            if [ "${ITER_SECMODE}" = "WEP" ]; then
#                echo $WEP_INTERFACE | grep "R${ITER_RADIO_ID}" > /dev/null
#                if [ $? -eq 0 ]; then
#                    echo "Unable to create additional WEP VAP"
#                    exit 255
#                else
#                    WEP_INTERFACE="R${ITER_RADIO_ID}"
#                fi
#            fi
            BEACON_INTVAL=$((100*$ITER_VAP_COUNT))
      
            if [ "${ITER_MODE}" = "sta-wds" -o "${ITER_MODE}" = "sta" ]; then
               if [ "${ITER_RADIO_ID}" = 0 -a "${STA_VAP_COUNT_RADIO_0}" != 1 ]; then
                 if [ "${AP_STARTMODE}" = "multi-ind" ]; then
                    if [ "${ITER_MODE}" = "sta-wds" ]; then
                      ST_MODE="sta-wds-ind"
                    else
                      ST_MODE="sta-nwds-ind"
                    fi
                    makeVAP $ST_MODE "$ITER_SSID" $ITER_RADIO_ID:$ITER_RFPARAM $BEACON_INTVAL
                 else
                    makeVAP $ITER_MODE "$ITER_SSID" $ITER_RADIO_ID:$ITER_RFPARAM $BEACON_INTVAL
                 fi
                    NUM_VAP=$(($NUM_VAP+1))
		    iwconfig | grep -c ath | grep -i $NUM_VAP > /dev/null               
		    if [ $? != 0 ]; then
		           echo "Unable to create VAP!"
		    	   exit
	            fi
	            STA_VAP_COUNT_RADIO_0=1
               else 
                 if [ "${ITER_RADIO_ID}" = 1 -a "${STA_VAP_COUNT_RADIO_1}" != 1 ]; then
                    if [ "${AP_STARTMODE}" = "multi-ind" ]; then
                      if [ "${ITER_MODE}" = "sta-wds" ]; then
                        ST_MODE="sta-wds-ind"
                      else
                        ST_MODE="sta-nwds-ind"
                      fi
                       makeVAP $ST_MODE "$ITER_SSID" $ITER_RADIO_ID:$ITER_RFPARAM $BEACON_INTVAL
                    else
		       makeVAP $ITER_MODE "$ITER_SSID" $ITER_RADIO_ID:$ITER_RFPARAM $BEACON_INTVAL
                    fi
		      NUM_VAP=$(($NUM_VAP+1))
		      iwconfig | grep -c ath | grep -i $NUM_VAP > /dev/null               
		      if [ $? != 0 ]; then
		              echo "Unable to create VAP!"
		      	      exit
	              fi
	              STA_VAP_COUNT_RADIO_1=1
	         else
	            echo "**Maximum sta / sta-wds VAPs exceeded!!!!"
		 fi
	     fi
            else       
              if [ "${AP_STARTMODE}" = "multi-ind" ]; then
                 if [ "${ITER_MODE}" = "ap-wds" ]; then
                     AP_IN_MODE="ap-wds-ind"
                 else
                     AP_IN_MODE="ap-nwds-ind"
                 fi
                  makeVAP $AP_IN_MODE "$ITER_SSID" $ITER_RADIO_ID:$ITER_RFPARAM $BEACON_INTVAL $NUM_VAP 1
              else
#                 makeVAP $ITER_MODE "$ITER_SSID" $ITER_RADIO_ID:$ITER_RFPARAM $BEACON_INTVAL $NUM_VAP 1
                  #ARRIS ADD -  wlanaddr
                  wlanconfig ath$NUM_VAP create wlandev wifi$ITER_RADIO_ID wlanmode ap wlanaddr "${ITER_VAP_BSSID:="00:11:22:33:44:55"}"
              fi
                 NUM_VAP=$(($NUM_VAP+1))
	         #iwconfig | grep -c ath | grep -i $NUM_VAP > /dev/null               
	         #if [ $? != 0 ]; then
	         #         echo "Unable to create VAP!"
	         #         exit
	         #fi
            fi 
#       fi
        if [ "${ITER_MODE}" = "sta-wds" -a "${ITER_SECMODE}" != "WPA" -a "${ITER_ROOTAP_MAC}" != "" ]; then
            iwconfig $VAP_NAME ap $ITER_ROOTAP_MAC
        fi
    done
fi
