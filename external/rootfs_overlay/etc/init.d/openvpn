#!/bin/sh
#
# Original version by Robert Leslie
# <rob@mars.org>, edited by iwj and cs
# Modified for openvpn by Alberto Gonzalez Iniesta <agi@agi.as>
# Modified for restarting / starting / stopping single tunnels by Richard Mueller <mueller@teamix.net>

test $DEBIAN_SCRIPT_DEBUG && set -v -x

CONFIG_DIR=/etc/openvpn
test -d $CONFIG_DIR || exit 0

BRIDGE_IF="br0"
TAP_IF=""
NAMESERVER_IP=$(cat /etc/resolv.conf |grep -m1 -i '^nameserver'|cut -d ' ' -f2)

start_vpn () {

	TAP_IF=$(openvpn --mktun --dev tap | grep -o ' tap.* ' | xargs)
	if [ -n "$TAP_IF" ]; then
		ip link set dev $TAP_IF up
		brctl addif $BRIDGE_IF $TAP_IF
		/usr/sbin/openvpn --daemon --writepid /var/run/openvpn.$NAME.pid --dev $TAP_IF \
			--config $CONFIG_DIR/$NAME.conf --cd $CONFIG_DIR --script-security 2 \
			--push "dhcp-option DNS $NAMESERVER_IP" || printf " FAILED->"
	else
		printf " FAILED->"
	fi

	printf " $NAME"

}

stop_vpn () {

	TAP_IF=$(cat "/proc/$(cat /var/run/openvpn.$NAME.pid)/cmdline" | xargs -0 -n2 | grep "\-\-dev"|cut -f2 -d" ")

	kill `cat $PIDFILE` || true
	rm $PIDFILE

	if [ -n "$TAP_IF" ]; then
		brctl delif $BRIDGE_IF $TAP_IF
		ip link set dev $TAP_IF down
		openvpn --rmtun --dev $TAP_IF || printf " FAILED->"
	fi
	
	printf " $NAME"

}

case "$1" in
start)
printf "Starting openvpn:"

  # Load TUN/TAP modules.
  [ ! -c /dev/net/tun ] && insmod /lib/modules/tun.ko
  if test -z $2 ; then
    for CONFIG in `cd $CONFIG_DIR; ls *.conf 2> /dev/null`; do
      NAME=${CONFIG%%.conf}
      start_vpn
    done
  else
    if test -e $CONFIG_DIR/$2.conf ; then
      NAME=$2
      start_vpn
    else
      printf " No such VPN: $2"
    fi
  fi
  echo "."

  ;;
stop)
  printf "Stopping openvpn:"

  if test -z $2 ; then
    for PIDFILE in `ls /var/run/openvpn.*.pid 2> /dev/null`; do
      NAME=`echo $PIDFILE | cut -c18-`
      NAME=${NAME%%.pid}
      stop_vpn
      printf " $NAME"
    done
  else
    if test -e /var/run/openvpn.$2.pid ; then
      PIDFILE=`ls /var/run/openvpn.$2.pid 2> /dev/null`
      NAME=`echo $PIDFILE | cut -c18-`
      NAME=${NAME%%.pid}
      stop_vpn
    else
      printf " No such VPN: $2"
    fi
  fi
  [ -c /dev/net/tun ] && rmmod tun

  echo "."
  ;;
# We only 'reload' for running VPNs. New ones will only start with 'start' or 'restart'.
reload|force-reload)
  printf "Reloading openvpn:"
  for PIDFILE in `ls /var/run/openvpn.*.pid 2> /dev/null`; do
    NAME=`echo $PIDFILE | cut -c18-`
    NAME=${NAME%%.pid}
# If openvpn if running under a different user than root we'll need to restart
    if egrep '^( |\t)*user' $CONFIG_DIR/$NAME.conf > /dev/null 2>&1 ; then
      stop_vpn
      sleep 1
      start_vpn
      printf "(restarted)"
    else
      kill -HUP `cat $PIDFILE` || true
    printf " $NAME"
    fi
  done
  echo "."
  ;;

restart)
  $0 stop $2
  sleep 1
  $0 start $2
  ;;
*)
  echo "Usage: $0 {start|stop|reload|restart|force-reload}" >&2
  exit 1
  ;;
esac

exit 0

