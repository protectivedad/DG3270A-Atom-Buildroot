#!/bin/sh
#-----------------------------------------------------------------------------
# This file is provided under a dual BSD/GPLv2 license.  When using or
# redistributing this file, you may do so under either license.
#
# GPL LICENSE SUMMARY
#
# Copyright(c) 2007-2012 Intel Corporation. All rights reserved.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of version 2 of the GNU General Public License as
# published by the Free Software Foundation.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.
# The full GNU General Public License is included in this distribution
# in the file called LICENSE.GPL.
#
# Contact Information:
#      Intel Corporation
#      2200 Mission College Blvd.
#      Santa Clara, CA  97052
#
# BSD LICENSE
#
# Copyright(c) 2007-2012 Intel Corporation. All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
#
#   - Redistributions of source code must retain the above copyright
#     notice, this list of conditions and the following disclaimer.
#   - Redistributions in binary form must reproduce the above copyright
#     notice, this list of conditions and the following disclaimer in
#     the documentation and/or other materials provided with the
#     distribution.
#   - Neither the name of Intel Corporation nor the names of its
#     contributors may be used to endorse or promote products derived
#     from this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
# "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
# LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
# A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
# OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
# SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
# LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
# DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
# THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#-----------------------------------------------------------------------------

PATH=/usr/local/bin:/usr/bin:/bin:/sbin

. /etc/init.d/init_utilities

# runtime_pm is enabled for PCI devices with:
#   echo auto > /sys/bus/pci/devices/xxxx:bb:dd.f/power/control    
# where
#   xxxx	is the device domain -- always 0000 for us.
#   bb	    is the bus number
#               - PCIe and SATe are on bus 0.
#               - all other CE devices are on the AV Bridge (bus 1).
#   dd.f	are the device/function numbers (each in hex).
#       
#                             driver          Device ID (VendorID=8086)
#                             -----------     ---------
AUDIO_DSP0=0000:01:06.0     # audio           2E5F
AUDIO_DSP1=0000:01:06.1     # audio           2E5F
AUDIO_IF=0000:01:06.2       # audio           2E60
CRU_ETH=0000:01:0c.1        # ismdclock       2E6F
DPE=0000:01:08.1            # vidpproc        2E62
EPU=0000:01:1a.0            # videnc          089C
GBE=0000:01:0c.0            # e1000           2E6E
GC300=0000:01:16.0          # 2D graphics     070A
GVSPARC_D=0000:01:19.0      # viddec          089D no such device on CE4200
GVSPARC_T=0000:01:11.0      # mux             0703 driver=viddec on CE4200
H264VE=0000:01:13.0         # videnc          0706
HDMI_RX=0000:01:18.0        # hdmi-rx         089E
HDMI_TX=0000:01:08.2        # display         2E63
HDVCAP=0000:01:12.0         # vidcap          0704
PCIE0=0000:00:1c.0          # pcieport        0899 (DevID=0101 on CE4200)
PCIE1=0000:00:1c.1          # pcieport        089A (DevID=0202 on CE4200)
SATA=0000:00:0e.0           # ahci            0C82 (DevID=2E71 on CE4200)
SEC=0000:01:09.0            # sec             2E64
SGX=0000:01:02.0            # 3D graphics     089B (DevID=2E5B on CE4200)
USB1=0000:01:0d.0           # ehci_hcd        0101 (VendorID=192E)
USB2=0000:01:0d.1           # ehci_hcd        0101 (VendorID=192E)
USB3=0000:01:0d.2           # ehci_hcd        0101 (VendorID=192E)
USB4=0000:01:0d.3           # ehci_hcd        0101 (VendorID=192E)
VDC=0000:01:08.0            # display         2E61

# $1 = name of PCI device directory in sys filesystem
enable() {
    if [ -f /sys/bus/pci/devices/$1/power/control ] ; then
        echo auto > /sys/bus/pci/devices/$1/power/control
    fi
}

start_function() {
    # runtime_pm cannot co-exist with the STANDBY3 power mode implemented on
    # CE4200. Until such time as support for that mode is removed (not currently
    # planned), do not enable runtime_pm on CE4200.

    echo 1 > /proc/icepm/devicecheck

    SOC_NAME=`get_soc_info_utility NAME STRING 2>/dev/null`

    if [ x"$SOC_NAME" = xSOC_NAME_CE5300 ] ; then
        enable $AUDIO_DSP0
        enable $AUDIO_DSP1
        enable $AUDIO_IF
        enable $CRU_ETH
        enable $DPE
        enable $EPU
        enable $GBE
        enable $GC300
        enable $GVSPARC_D
        enable $GVSPARC_T
        enable $H264VE
        enable $HDMI_RX
        enable $HDMI_TX
        enable $HDVCAP
        enable $PCIE0
        enable $PCIE1
        enable $SATA
        enable $SEC
        enable $SGX
        enable $USB1
        enable $USB2
        enable $USB3
        enable $USB4
        enable $VDC
    fi
}

#stop_function() {
#}

case $1 in
    "start")
        start_function
        ;;
    "stop")
        #stop_function
        ;;
    "restart")
        #stop_function
        start_function
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
esac
